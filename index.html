<script>
document.getElementById("formPonto").addEventListener("submit", async (e) => {
  e.preventDefault();
  const mensagem = document.getElementById("mensagem");
  
  try {
    mensagem.innerHTML = '<div class="loading">Enviando dados...<div class="spinner"></div></div>';
    
    // Coletar dados do formulário
    const formData = {
      nome: e.target.nome.value,
      setor: e.target.setor.value,
      tipo: e.target.tipo.value,
      obs: e.target.obs.value || '',
      latitude: document.getElementById('latitude').value || '0',
      longitude: document.getElementById('longitude').value || '0'
    };

    // URL do seu Web App (substitua se necessário)
    const webAppUrl = "https://script.google.com/macros/s/AKfycbxYRN7kYFcaTd093nxVmzphpEw355DrYX9Mduc8we1srlJVw8stOEN_JIGt932XsggG/exec";
    
    // Método 1: Usando fetch com tratamento especial para Google Apps Script
    const response = await fetch(`${webAppUrl}?${new URLSearchParams(formData).toString()}`, {
      method: 'POST',
      redirect: 'follow',
      headers: {
        'Content-Type': 'text/plain;charset=UTF-8'
      }
    });

    // Verificar resposta
    const result = await response.text();
    
    if (result.includes('sucesso') || response.ok) {
      mensagem.innerHTML = '<div class="success">✅ Ponto registrado com sucesso!</div>';
      e.target.reset();
    } else {
      throw new Error(result || 'Resposta inválida do servidor');
    }
    
  } catch (error) {
    console.error('Erro detalhado:', error);
    mensagem.innerHTML = `
      <div class="error">
        <strong>❌ Erro ao enviar:</strong><br>
        <small>${error.message.replace('Failed to fetch', 'Problema de conexão')}</small><br>
        <button onclick="location.reload()" class="retry-btn">Tentar Novamente</button>
      </div>
    `;
    
    // Método alternativo se fetch falhar
    if (error.message.includes('Failed to fetch')) {
      await enviarViaXHR(formData, mensagem);
    }
  }
});

// Método alternativo usando XMLHttpRequest
function enviarViaXHR(data, mensagemEl) {
  return new Promise((resolve) => {
    const xhr = new XMLHttpRequest();
    const url = "https://script.google.com/macros/s/AKfycbxYRN7kYFcaTd093nxVmzphpEw355DrYX9Mduc8we1srlJVw8stOEN_JIGt932XsggG/exec?callback=?";

    xhr.open('POST', url, true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    
    xhr.onload = function() {
      if (this.status >= 200 && this.status < 300) {
        mensagemEl.innerHTML = '<div class="success">✅ Ponto registrado (método alternativo)!</div>';
      } else {
        mensagemEl.innerHTML = `<div class="error">Erro ${this.status}: ${this.statusText}</div>`;
      }
      resolve();
    };
    
    xhr.onerror = function() {
      mensagemEl.innerHTML = '<div class="error">❌ Falha na conexão (método alternativo)</div>';
      resolve();
    };
    
    xhr.send(new URLSearchParams(data).toString());
  });
}
</script>

<style>
.loading, .success, .error {
  padding: 10px;
  margin: 10px 0;
  border-radius: 5px;
}
.loading {
  background: #e7f5fe;
  color: #31708f;
}
.success {
  background: #dff0d8;
  color: #3c763d;
}
.error {
  background: #f2dede;
  color: #a94442;
}
.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(0,0,0,.3);
  border-radius: 50%;
  border-top-color: #000;
  animation: spin 1s ease-in-out infinite;
  margin-left: 10px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.retry-btn {
  margin-top: 10px;
  padding: 5px 15px;
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
}
</style>
